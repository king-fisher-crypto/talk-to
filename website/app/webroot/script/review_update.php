<?php

//Spiriteo CMS

$mysqli = new mysqli($dbb_head['host'], "spiriteo", "m3UFeJ9382rPQ9m8tQPqM4es", "spiriteo");
			$MatchPourcent_old = array(
			100	=> 5,
99	=> 4.9,
98	=> 4.8,
97	=> 4.7,
96	=> 4.6,
95	=> 4.5,
94	=> 4.4,
93	=> 4.3,
92	=> 4.2,
91	=> 4.1,
90	=> 4,
89	=> 3.9,
88	=> 3.8,
87	=> 3.7,
86	=> 3.6,
85	=> 3.5,
84	=> 3.4,
83	=> 3.3,
82	=> 3.2,
81	=> 3.1,
80	=> 3,
79	=> 2.9,
78	=> 2.8,
77	=> 2.7,
76	=> 2.6,
75	=> 2.5,
74	=> 2.4,
73	=> 2.3,
72	=> 2.2,
71	=> 2.1,
70	=> 2,
69	=> 1.9,
68	=> 1.8,
67	=> 1.7,
66	=> 1.6,
65	=> 1.5,
64	=> 1.4,
63	=> 1.3,
62	=> 1.2,
61	=> 1.1,
60	=> 1,
59	=> 1,
58	=> 1,
57	=> 1,
56	=> 1,
55	=> 1,
54	=> 1,
53	=> 1,
52	=> 1,
51	=> 1,
50	=> 1,
49	=> 1,
48	=> 1,
47	=> 1,
46	=> 1,
45	=> 1,
44	=> 1,
43	=> 1,
42	=> 1,
41	=> 1,
40	=> 1,
39	=> 1,
38	=> 1,
37	=> 1,
36	=> 1,
35	=> 1,
34	=> 1,
33	=> 1,
32	=> 1,
31	=> 1,
30	=> 1,
29	=> 1,
28	=> 1,
27	=> 1,
26	=> 1,
25	=> 1,
24	=> 1,
23	=> 1,
22	=> 1,
21	=> 1,
20	=> 1,
19	=> 1,
18	=> 1,
17	=> 1,
16	=> 1,
15	=> 1,
14	=> 1,
13	=> 1,
12	=> 1,
11	=> 1,
10	=> 1,
9	=> 1,
8	=> 1,
7	=> 1,
6	=> 1,
5	=> 1,
4	=> 1,
3	=> 1,
2	=> 1,
1	=> 1
		);

			$MatchPourcent = array(
			100	=> 5,
99	=> 4.95,
98	=> 4.90,
97	=> 4.85,
96	=> 4.80,
95	=> 4.75,
94	=> 4.70,
93	=> 4.65,
92	=> 4.60,
91	=> 4.55,
90	=> 4.50,
89	=> 4.45,
88	=> 4.40,
87	=> 4.35,
86	=> 4.30,
85	=> 4.25,
84	=> 4.20,
83	=> 4.15,
82	=> 4.10,
81	=> 4.05,
80	=> 4,
79	=> 3.95,
78	=> 3.90,
77	=> 3.85,
76	=> 3.80,
75	=>3.75,
74	=> 3.70,
73	=> 3.65,
72	=> 3.60,
71	=> 3.55,
70	=> 3.50,
69	=> 3.45,
68	=> 3.40,
67	=> 3.35,
66	=> 3.30,
65	=> 3.25,
64	=> 3.20,
63	=> 3.15,
62	=> 3.10,
61	=> 3.05,
60	=> 3.00,
59	=> 2.95,
58	=> 2.90,
57	=> 2.85,
56	=> 2.80,
55	=> 2.75,
54	=> 2.70,
53	=> 2.65,
52	=> 2.60,
51	=> 2.55,
50	=> 2.5,
49	=> 2.45,
48	=> 2.40,
47	=> 2.35,
46	=> 2.3,
45	=> 2.25,
44	=> 2.2,
43	=> 2.15,
42	=> 2.1,
41	=> 2.05,
40	=> 2,
39	=> 1.95,
38	=> 1.90,
37	=> 1.85,
36	=> 1.80,
35	=> 1.75,
34	=> 1.70,
33	=> 1.65,
32	=> 1.60,
31	=> 1.55,
30	=> 1.50,
29	=> 1.45,
28	=> 1.40,
27	=> 1.35,
26	=> 1.30,
25	=> 1.25,
24	=> 1.20,
23	=> 1.15,
22	=> 1.10,
21	=> 1.05,
20	=> 1,
19	=> 0.95,
18	=> 0.90,
17	=> 0.85,
16	=> 0.80,
15	=> 0.75,
14	=> 0.70,
13	=> 0.65,
12	=> 0.60,
11	=> 0.55,
10	=> 0.50,
9	=> 0.45,
8	=> 0.40,
7	=> 0.35,
6	=> 0.30,
5	=> 0.25,
4	=> 0.20,
3	=> 0.15,
2	=> 0.10,
1	=> 0.05
		);

$result = $mysqli->query("SELECT * from users where role = 'agent' order by id");
while($row = $result->fetch_array(MYSQLI_ASSOC)){	
	$avg = 0;
	$total = 0;
	$nb = 0;
	$result2 = $mysqli->query("SELECT * from reviews where agent_id = '".$row['id']."' and status = 1 and parent_id is NULL order by review_id");
	while($row2 = $result2->fetch_array(MYSQLI_ASSOC)){	
		$nb ++;
		$total += $MatchPourcent[$row2['pourcent']];//$row2['rate'];
	}
	if($nb){
		$avg = $total / $nb;
		$avg = number_format($avg,3);

		//$notation = $MatchPourcent[number_format($row['reviews_avg'],0)];
		//var_dump("update  users set reviews_avg = '".$avg."', reviews_nb = '".$nb."' WHERE id = '{$row['id']}'");exit;
		$mysqli->query("update  users set reviews_avg = '".$avg."', reviews_nb = '".$nb."' WHERE id = '{$row['id']}'");
	}
}
exit;
?>